// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique
  email       String   @unique
  password    String
  balance     Float    @default(0)
  gameCredit  Float    @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bets              Bet[]
  transactions      Transaction[]
  depositRequests   DepositRequest[]
  withdrawalRequests WithdrawalRequest[]
  paymentAuditLogs  PaymentAuditLog[]
  notifications     Notification[]

  @@map("users")
}

model Admin {
  id          String           @id @default(uuid())
  username    String           @unique
  email       String           @unique
  password    String
  role        AdminRole        @default(ADMIN)
  permissions AdminPermission[]
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  approvedTransactions Transaction[] @relation("ApprovedBy")
  auditLogs           AuditLog[]
  approvedDeposits    DepositRequest[]
  approvedWithdrawals WithdrawalRequest[]
  paymentAuditLogs    PaymentAuditLog[]

  @@map("admins")
}

model GameRound {
  id               String          @id @default(uuid())
  roundNumber      Int             @unique
  status           GameRoundStatus @default(BETTING)
  bettingStartTime DateTime        @default(now())
  bettingEndTime   DateTime?
  spinStartTime    DateTime?
  resultTime       DateTime?
  winningNumber    Int?
  winningColor     String?
  isWinningOdd     Boolean?
  totalBetAmount   Float           @default(0)
  totalPayout      Float           @default(0)
  houseProfitLoss  Float           @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  bets Bet[]

  @@map("game_rounds")
}

model Bet {
  id              String    @id @default(uuid())
  userId          String
  roundId         String
  betType         BetType
  betValue        String // JSON string to handle number | string
  amount          Float
  potentialPayout Float
  isWinner        Boolean?
  actualPayout    Float     @default(0)
  status          BetStatus @default(PENDING)
  placedAt        DateTime  @default(now())
  settledAt       DateTime?

  // Relations
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  round GameRound @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@map("bets")
}

model Transaction {
  id          String            @id @default(uuid())
  userId      String
  type        TransactionType
  amount      Float
  status      TransactionStatus @default(PENDING)
  description String
  reference   String?
  approvedBy  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver Admin? @relation("ApprovedBy", fields: [approvedBy], references: [id])

  @@map("transactions")
}

model GameConfig {
  id                String   @id @default(uuid())
  bettingDuration   Int      @default(30)
  spinDuration      Int      @default(10)
  resultDuration    Int      @default(15)
  minBetAmount      Float    @default(1)
  maxBetAmount      Float    @default(10000)
  payoutMultiplier  Float    @default(5)
  cashbackPercentage Float   @default(10)
  maxExposure       Float    @default(1000000)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("game_configs")
}

model AuditLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  target    String?
  targetId  String?
  oldValue  String? // JSON string
  newValue  String? // JSON string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  admin Admin @relation(fields: [adminId], references: [id])

  @@map("audit_logs")
}

model PaymentMethod {
  id           String   @id @default(uuid())
  name         String   @unique // 'phonepe', 'googlepay', 'paytm', 'usdt'
  displayName  String
  isActive     Boolean  @default(true)
  qrCodeUrl    String?  // URL to QR code image
  qrCodeData   String?  // QR code data/payload
  walletAddress String? // For USDT or other crypto
  instructions String?  // Payment instructions
  minAmount    Float    @default(10.00)
  maxAmount    Float    @default(100000.00)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  depositRequests DepositRequest[]

  @@map("payment_methods")
}

model DepositRequest {
  id              String         @id @default(uuid())
  userId          String
  paymentMethodId String
  amount          Float
  utrCode         String         // Unique Transaction Reference
  status          DepositStatus  @default(PENDING)
  adminNotes      String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedReason  String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  approver      Admin?        @relation(fields: [approvedBy], references: [id])

  @@map("deposit_requests")
}

model WithdrawalRequest {
  id              String           @id @default(uuid())
  userId          String
  amount          Float
  paymentMethod   String           // User's preferred method
  accountDetails  String           // JSON string with payment details
  status          WithdrawalStatus @default(PENDING)
  adminNotes      String?
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  rejectionReason String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver Admin? @relation(fields: [approvedBy], references: [id])

  @@map("withdrawal_requests")
}

model PaymentAuditLog {
  id         String   @id @default(uuid())
  entityType String   // 'deposit_request', 'withdrawal_request', 'payment_method'
  entityId   String
  action     String   // 'created', 'approved', 'rejected', 'updated'
  oldData    String?  // JSON string
  newData    String?  // JSON string
  adminId    String?
  userId     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  admin Admin? @relation(fields: [adminId], references: [id])
  user  User?  @relation(fields: [userId], references: [id])

  @@map("payment_audit_logs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // 'deposit_approved', 'withdrawal_rejected', etc.
  title     String
  message   String
  data      String?  // JSON string for additional data
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model SecurityLog {
  id        String   @id @default(uuid())
  type      String   // 'login_attempt', 'failed_login', 'suspicious_betting', etc.
  userId    String?
  details   String?  // JSON string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("security_logs")
}

// Enums
enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum AdminPermission {
  MANAGE_BETS
  MANAGE_USERS
  MANAGE_WITHDRAWALS
  MANAGE_DEPOSITS
  VIEW_ANALYTICS
  EMERGENCY_CONTROLS
  MANAGE_TIMERS
}

enum GameRoundStatus {
  BETTING
  BETTING_CLOSED
  SPINNING
  COMPLETED
  CANCELLED
}

enum BetType {
  NUMBER
  ODD_EVEN
  COLOR
}

enum BetStatus {
  PENDING
  WON
  LOST
  CANCELLED
  REFUNDED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BET_PLACED
  BET_WON
  BET_LOST
  CASHBACK
  ADMIN_ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
}